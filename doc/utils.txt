Lab creation:
_____________

oc new-project devops-tools --display-name='devops-tools' --description='devops-tools'

oc new-project automation-tools --display-name='automation-tools' --description='automation-tools'

oc adm policy add-cluster-role-to-user cluster-admin -z jenkins

oc adm policy add-cluster-role-to-user cluster-admin -z opentlc-mgr

oc project openshift

oc import-image jenkins-2-rhel7 --from=registry.access.redhat.com/openshift3/jenkins-2-rhel7:v3.10.127 --confirm

oc import-image jenkins-agent-maven-35-rhel7 --from=registry.access.redhat.com/openshift3/jenkins-agent-maven-35-rhel7:v3.10.127 --confirm

oc import-image fuse7/fuse-java-openshift --from=registry.redhat.io/fuse7/fuse-java-openshift --confirm

oc project devops-tools

oc new-app --template=jenkins-ephemeral -p JENKINS_IMAGE_STREAM_TAG=jenkins-2-rhel7:latest -p MEMORY_LIMIT=1024Mi -p ENABLE_OAUTH=true

oc project automation-tools

oc create -f automation-tools-custom-resource-limits.yaml

oc delete limits automation-tools-core-resource-limits

./setup_openshift.sh -e openshift_host=https://master.bcn-ffce.openshiftworkshop.com -e openshift_project=automation-tools -e openshift_user=opentlc-mgr -e openshift_password=r3dh4t1! -e admin_password=admin1 -e secret_key=mysecret -e pg_username=postgresuser -e pg_password=postgrespwd -e rabbitmq_password=rabbitpwd -e rabbitmq_erlang_cookie=rabbiterlangpwd

oc adm policy add-cluster-role-to-user cluster-admin -z jenkins


End Lab creation
________________


oc delete bc sales-deploy-ticket-processor-pipeline
oc delete bc sales-deploy-stock-processor-pipeline
oc delete bc sales-deploy-stock-query-pipeline
oc delete bc sales-infra-pipeline
oc delete bc sales-init-pipeline
oc delete bc sales-prereqs-pipeline

oc start-build sales-init-pipeline -n cicd-ocpadmin

https://github.com/openshift/library

Jenkins Installation

____________________

Jenkins credentials: https://github.com/openshift/jenkins-client-plugin#setting-up-credentials


oc start-build <buildconfig_name> --env=<key>=<value>


oc policy add-role-to-group system:image-puller system:serviceaccounts:cicd-ocpadmin -n ctti-app-dev

oc policy add-role-to-group system:image-puller system:serviceaccounts:cicd-ocpadmin -n ctti-app-pre

oc policy add-role-to-group system:image-puller system:serviceaccounts:cicd-ocpadmin -n ctti-app-pro

oc policy add-role-to-user edit system:serviceaccount:cicd-ocpadmin:jenkins -n ocp-microservices-ddd

oc policy add-role-to-user edit system:serviceaccount:cicd-ocpadmin:jenkins -n ocp-microservices-ddd

oc policy add-role-to-group system:image-puller system:serviceaccounts:ocp-microservices-ddd -n ocp-microservices-ddd

oc new-project cicd-ocpadmin --display-name='cicd-ocpadmin' --description='cicd-ocpadmin'

oc policy add-role-to-user edit system:serviceaccount:cicd-ocpadmin:jenkins -n ctti-app-dev

oc policy add-role-to-user edit system:serviceaccount:cicd-ocpadmin:jenkins -n ctti-app-pre

oc policy add-role-to-user edit system:serviceaccount:cicd-ocpadmin:jenkins -n ctti-app-pro

oc policy add-role-to-group system:image-puller system:serviceaccounts:ctti-app-pre -n ctti-app-dev

oc policy add-role-to-group system:image-puller system:serviceaccounts:ctti-app-pro -n ctti-app-dev

oc new-app --template=jenkins-ephemeral -p JENKINS_IMAGE_STREAM_TAG=jenkins:2 -p NAMESPACE=openshift -p MEMORY_LIMIT=512Mi -p ENABLE_OAUTH=true

oc new-app --template=jenkins-ephemeral -p JENKINS_IMAGE_STREAM_TAG=jenkins-2-centos7:latest -p NAMESPACE=openshift -p MEMORY_LIMIT=512Mi -p ENABLE_OAUTH=true

oc get is

oc import-image jenkins-2-rhel7 --from=registry.access.redhat.com/openshift3/jenkins-2-rhel7:v3.10.127 --confirm

oc import-image jenkins-agent-maven-35-rhel7 --from=registry.access.redhat.com/openshift3/jenkins-agent-maven-35-rhel7:v3.10.127 --confirm

oc new-app --template=jenkins-ephemeral -p JENKINS_IMAGE_STREAM_TAG=jenkins-2-rhel7:latest -p MEMORY_LIMIT=512Mi -p ENABLE_OAUTH=true

oc adm policy add-cluster-role-to-user cluster-admin -z jenkins

oc adm policy add-cluster-role-to-user cluster-admin -z admin

oc adm policy add-cluster-role-to-user cluster-admin -z jbuenosv-redhat.com

oc import-image fuse7/fuse-java-openshift --from=registry.redhat.io/fuse7/fuse-java-openshift --confirm

oc apply -f v3.11/xpaas-streams/datagrid71-image-stream.json -n openshift


eval $(minishift docker-env)
docker login -p $(oc whoami -t) 172.30.1.1:5000
docker pull registry.redhat.io/jboss-datagrid-7/datagrid71-openshift:1.3



- pipelines template creation

oc create -n cicd-ocpadmin -f ctti.yaml



oc login https://masterdns6fkvd2aq5m6cg.westeurope.cloudapp.azure.com:443 --token=RCf0OMDEJkNyx90RoErAdWqX3gOFz87a18WmXSagEVU

Templates execution

oc start-build sales-prereqs-pipeline -n cicd-ocpadmin --env=SEC_TOKEN=RCf0OMDEJkNyx90RoErAdWqX3gOFz87a18WmXSagEVU --wait
oc start-build sales-init-pipeline -n cicd-ocpadmin --env=SEC_TOKEN=RCf0OMDEJkNyx90RoErAdWqX3gOFz87a18WmXSagEVU --wait
oc start-build sales-infra-pipeline -n cicd-ocpadmin --env=SEC_TOKEN=RCf0OMDEJkNyx90RoErAdWqX3gOFz87a18WmXSagEVU --wait
oc start-build sales-deploy-ticket-processor-pipeline -n cicd-ocpadmin --env=SEC_TOKEN=RW0cqv6L3VmIy1y5ojhlz0Aft_gGLcepevoYCcti_W54 --wait
oc start-build sales-deploy-stock-query-pipeline -n cicd-ocpadmin --env=SEC_TOKEN=W0cqv6L3VmIy1y5ojhlz0Aft_gGLcepevoYCcti_W54 --wait
oc start-build sales-deploy-stock-processor-pipeline -n cicd-ocpadmin --env=SEC_TOKEN=W0cqv6L3VmIy1y5ojhlz0Aft_gGLcepevoYCcti_W54 --wait


oc start-build sales-prereqs-pipeline -n cicd-ocpadmin --env=SEC_TOKEN=vt8_ZHhj1RrMOGJTXevgjvQQCwvOCqRiD6VfKgVYVpM
oc start-build sales-init-pipeline -n cicd-ocpadmin --env=SEC_TOKEN=vt8_ZHhj1RrMOGJTXevgjvQQCwvOCqRiD6VfKgVYVpM
oc start-build sales-infra-pipeline -n cicd-ocpadmin --env=SEC_TOKEN=vt8_ZHhj1RrMOGJTXevgjvQQCwvOCqRiD6VfKgVYVpM
oc start-build sales-deploy-ticket-processor-pipeline -n cicd-ocpadmin --env=SEC_TOKEN=vt8_ZHhj1RrMOGJTXevgjvQQCwvOCqRiD6VfKgVYVpM
oc start-build sales-deploy-stock-query-pipeline -n cicd-ocpadmin --env=STOCKEC_TOKEN=vt8_ZHhj1RrMOGJTXevgjvQQCwvOCqRiD6VfKgVYVpM
oc start-build sales-deploy-stock-processor-pipeline -n cicd-ocpadmin --env=SEC_TOKEN=vt8_ZHhj1RrMOGJTXevgjvQQCwvOCqRiD6VfKgVYVpM



oc login https://192.168.99.100:8443 --token=vt8_ZHhj1RrMOGJTXevgjvQQCwvOCqRiD6VfKgVYVpM


Login

curl -X GET -H "Authorization: Bearer bOVJsmTpvW2UCQsfu7Wx0p-DoIsT5hHavBC8gQtJR7k" https://192.168.99.100:8443/oapi/v1 --insecure

Execute a build config:

curl -X POST -H "Content-Type: application/json" -k https://192.168.99.100:8443/apis/build.openshift.io/v1/namespaces/cicd-ocpadmin/buildconfigs/sales-prereqs-pipeline/webhooks/secretvalue1/generic

curl -X POST -H "Content-Type: application/json" -k https://192.168.99.100:8443/apis/build.openshift.io/v1/namespaces/cicd-ocpadmin/buildconfigs/sales-init-pipeline/webhooks/secretvalue1/generic

curl -X POST -H "Content-Type: application/json" -k https://192.168.99.100:8443/apis/build.openshift.io/v1/namespaces/cicd-ocpadmin/buildconfigs/sales-infra-pipeline/webhooks/secretvalue1/generic

curl -X POST -H "Content-Type: application/json" -k https://192.168.99.100:8443/apis/build.openshift.io/v1/namespaces/cicd-ocpadmin/buildconfigs/sales-deploy-ticket-processor-pipeline/webhooks/secretvalue1/generic

curl -X POST -H "Content-Type: application/json" -k https://192.168.99.100:8443/apis/build.openshift.io/v1/namespaces/cicd-ocpadmin/buildconfigs/sales-deploy-stock-query-pipeline/webhooks/secretvalue1/generic

curl -X POST -H "Content-Type: application/json" -k https://192.168.99.100:8443/apis/build.openshift.io/v1/namespaces/cicd-ocpadmin/buildconfigs/sales-deploy-stock-processor-pipeline/webhooks/secretvalue1/generic


CTTI:

curl -X POST -H "Content-Type: application/json" -H "Authorization: Bearer 792YNsLAJv1P0TwWF50fhIEtelVnOyWmpEgEZOxJyPY" -k https://masterdns6fkvd2aq5m6cg.westeurope.cloudapp.azure.com:443/apis/build.openshift.io/v1/namespaces/cicd-ocpadmin/buildconfigs/sales-prereqs-pipeline/webhooks/secretvalue2/generic

curl -X POST -H "Content-Type: application/json" -H "Authorization: Bearer 792YNsLAJv1P0TwWF50fhIEtelVnOyWmpEgEZOxJyPY" -k https://masterdns6fkvd2aq5m6cg.westeurope.cloudapp.azure.com:443/apis/build.openshift.io/v1/namespaces/cicd-ocpadmin/buildconfigs/sales-init-pipeline/webhooks/secretvalue2/generic

curl -X POST -H "Content-Type: application/json" -H "Authorization: Bearer 792YNsLAJv1P0TwWF50fhIEtelVnOyWmpEgEZOxJyPY" -k https://masterdns6fkvd2aq5m6cg.westeurope.cloudapp.azure.com:443/apis/build.openshift.io/v1/namespaces/cicd-ocpadmin/buildconfigs/sales-infra-pipeline/webhooks/secretvalue2/generic

curl -X POST -H "Content-Type: application/json" -H "Authorization: Bearer 792YNsLAJv1P0TwWF50fhIEtelVnOyWmpEgEZOxJyPY" -k https://masterdns6fkvd2aq5m6cg.westeurope.cloudapp.azure.com:443/apis/build.openshift.io/v1/namespaces/cicd-ocpadmin/buildconfigs/sales-deploy-ticket-processor-pipeline/webhooks/secretvalue2/generic

curl -X POST -H "Content-Type: application/json" -H "Authorization: Bearer 792YNsLAJv1P0TwWF50fhIEtelVnOyWmpEgEZOxJyPY" -k https://masterdns6fkvd2aq5m6cg.westeurope.cloudapp.azure.com:443/apis/build.openshift.io/v1/namespaces/cicd-ocpadmin/buildconfigs/sales-deploy-stock-query-pipeline/webhooks/secretvalue2/generic

curl -X POST -H "Content-Type: application/json" -H "Authorization: Bearer 792YNsLAJv1P0TwWF50fhIEtelVnOyWmpEgEZOxJyPY" -k https://masterdns6fkvd2aq5m6cg.westeurope.cloudapp.azure.com:443/apis/build.openshift.io/v1/namespaces/cicd-ocpadmin/buildconfigs/sales-deploy-stock-processor-pipeline/webhooks/secretvalue2/generic


-d "{\"query\":\"$name\", \"turnOff\":true}"

curl -X POST -H "Content-Type: application/json" -d "{\"SEC_TOKEN\":\"zgqrq5D8-C3a4SoRJSZ-KBO2uh-BQRpTwLTDTanqKAU\"}" -k https://192.168.99.100:8443/apis/build.openshift.io/v1/namespaces/cicd-ocpadmin/buildconfigs/sales-prereqs-pipeline/webhooks/secretvalue1/generic

curl -X POST -H "Content-Type: application/json" -d "{\"sec_token_param\":\"zgqrq5D8-C3a4SoRJSZ-KBO2uh-BQRpTwLTDTanqKAU\"}" -k https://192.168.99.100:8443/apis/build.openshift.io/v1/namespaces/cicd-ocpadmin/buildconfigs/sales-prereqs-pipeline/webhooks/secretvalue1/generic


FhIT3FwP1t9eAB0GIiBUtY9D6iMEbxT0uBdS9Y9DN2g


FhIT3FwP1t9eAB0GIiBUtY9D6iMEbxT0uBdS9Y9DN2g


Token para la API de CTTI
eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJ0b3dlciIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJqbGJ1ZW5vc3Zpbm9zLXRva2VuLXAyanoyIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImpsYnVlbm9zdmlub3MiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiIzZWQ2MzQyZi01MGE2LTExZTktYjg5MC0wMDBkM2E0NDcyZWYiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6dG93ZXI6amxidWVub3N2aW5vcyJ9.ppAUlZUS4K3l9kfROYfCbekOK5YTrPVCdJxhjtZOm3jxpAUc21q-VRU0KQCzyp5OK0StYhHWmtPU7a1b4uU4nHvMn6CrS0C1D5xDd85I88-AUlJGEOT-IIyjfqjSX7IV2Ee5JhvH7KNs052OAvBt6JIyZA2TvyW2u3iq5pawICElglUMKzbFjR1-xdxxmcTlbm9XqsBQPGKrJU2Ct3xDzNYv3Kl0GYG4un0ydCnheqFMGh2cHQxBB7MKdFwrOSHtN6Y-W5rxIbP39Ds62_QDa7uVC6oHfiu827De4IcHZbAwHTcmzpYrCMN7ZOkC5VyPuDQrNh0xY4ebbXI5ZXaFWA


oc login https://192.168.99.106:8443 --token=LQJorhpo0RKjfVOBy83hJM_KrXVlAO2IJwsOlTArlkQ



docker login -u admin -p LQJorhpo0RKjfVOBy83hJM_KrXVlAO2IJwsOlTArlkQ docker-registry-default.192.168.99.106.nip.io

docker login -u jbuenosv -p RCf0OMDEJkNyx90RoErAdWqX3gOFz87a18WmXSagEVU https://docker-registry-default.51.144.36.254.nip.io



-- JENKINS PERMISSIONS TO CREATE PROJECTS

cat << EOF > clusterpolicy.json
{
  "apiVersion": "v1",
  "kind": "ClusterRole",
  "metadata": {
    "name": "create_project_role"
  },
  "rules": [
  {
      "verbs": ["create"],
      "resources": ["projectrequests"]
  },
  {
      "verbs": ["get","list","watch"],
      "resources": ["*"]
  }
  ]
}
EOF

oc create -f clusterpolicy.json


oc adm policy add-cluster-role-to-user cluster-admin -z jenkins


-- END JENKINS PERMISSIONS TO CREATE PROJECTS



AQM 7 Installation
__________________

oc login -u admin:admin

oc create -n openshift -f https://raw.githubusercontent.com/jboss-container-images/jboss-amq-7-broker-openshift-image/71-1.0.TP/amq-broker-7-image-streams.yaml

oc replace -n openshift --force -f https://raw.githubusercontent.com/jboss-container-images/jboss-amq-7-broker-openshift-image/71-1.0.TP/amq-broker-7-image-streams.yaml

oc -n openshift import-image amq-broker-71-openshift:1.0

oc create -n openshift -f https://raw.githubusercontent.com/jboss-container-images/jboss-amq-7-broker-openshift-image/71-1.0.TP/templates/amq-broker-71-basic.yaml

oc create -n openshift -f https://raw.githubusercontent.com/jboss-container-images/jboss-amq-7-broker-openshift-image/71-1.0.TP/templates/amq-broker-71-ssl.yaml

oc create -n openshift -f https://raw.githubusercontent.com/jboss-container-images/jboss-amq-7-broker-openshift-image/71-1.0.TP/templates/amq-broker-71-persistence.yaml

oc create -n openshift -f https://raw.githubusercontent.com/jboss-container-images/jboss-amq-7-broker-openshift-image/71-1.0.TP/templates/amq-broker-71-persistence-ssl.yaml

oc create -n openshift -f https://raw.githubusercontent.com/jboss-container-images/jboss-amq-7-broker-openshift-image/71-1.0.TP/templates/amq-broker-71-statefulset-clustered.yaml

oc replace -n openshift -f https://raw.githubusercontent.com/jboss-container-images/jboss-amq-7-broker-openshift-image/71-1.0.TP/templates/amq-broker-71-basic.yaml

oc replace -n openshift -f https://raw.githubusercontent.com/jboss-container-images/jboss-amq-7-broker-openshift-image/71-1.0.TP/templates/amq-broker-71-ssl.yaml

oc replace -n openshift -f https://raw.githubusercontent.com/jboss-container-images/jboss-amq-7-broker-openshift-image/71-1.0.TP/templates/amq-broker-71-persistence.yaml

oc replace -n openshift -f https://raw.githubusercontent.com/jboss-container-images/jboss-amq-7-broker-openshift-image/71-1.0.TP/templates/amq-broker-71-persistence-ssl.yaml

oc replace -n openshift -f https://raw.githubusercontent.com/jboss-container-images/jboss-amq-7-broker-openshift-image/71-1.0.TP/templates/amq-broker-71-statefulset-clustered.yaml

oc policy add-role-to-user view -z default


Maven
_____

export MAVEN_HOME=/Applications/Tools/apache-maven-3.5.0
export PATH=$PATH:$MAVEN_HOME/bin/


Project delete
________________

oc delete project ocp-microservices-ddd


Project creation
________________

oc new-project ocp-microservices-ddd


amq 6.3
_______

oc new-app --template=amq63-persistent -p MQ_USERNAME=sales-event-store -p MQ_PASSWORD=sales-event-store -p APPLICATION_NAME=sales-event-store


AMQ 7.1
_______

oc new-app --template=amq-broker-71-statefulset-clustered -p APPLICATION_NAME=sales-event-store -p AMQ_NAME=sales-event-store -p AMQ_CLUSTERED=true -p AMQ_CLUSTER_USER=sales-event-store -p AMQ_CLUSTER_PASSWORD=sales-event-store -p AMQ_REPLICATED=true -p AMQ_REPLICAS=2


data grid
_________
_________

oc new-app --template=datagrid71-basic -p USERNAME=sales-data-store -p PASSWORD=sales-data-store-Mypassword123_ -p APPLICATION_NAME=sales-data-store -p INFINISPAN_CONNECTORS=rest,hotrod,memcached -p CACHE_NAMES=STOCK -p HOTROD_AUTHENTICATION=true -p CONTAINER_SECURITY_ROLE_MAPPER=identity-role-mapper -p CONTAINER_SECURITY_ROLES=sales-data-store=ALL -p ADMIN_GROUP=REST,___schema_manager,sales-data-store -p MEMCACHED_CACHE=""


Patching the sales-data-store deployment adding the STOCK cache configuration
_____________________________________________________________________________

oc env dc/sales-data-store STOCK_CACHE_START=EAGER STOCK_CACHE_SECURITY_AUTHORIZATION_ENABLED=true  STOCK_CACHE_SECURITY_AUTHORIZATION_ROLES=sales-data-store,___schema_manager,___script_manager HOTROD_AUTHENTICATION=true  CONTAINER_SECURITY_ROLE_MAPPER=identity-role-mapper CONTAINER_SECURITY_ROLES=sales-data-store\\=ALL  ADMIN_GROUP=REST,___schema_manager,sales-data-store


AMQ-Streams
-----------

sed -i '' 's/namespace: .*/namespace: ocp-microservices-ddd/' install/cluster-operator/*RoleBinding*.yaml

oc apply -f install/cluster-operator -n ocp-microservices-ddd

oc apply -f examples/templates/cluster-operator -n ocp-microservices-ddd


MS deployment
_____________


ticket-processor-service
------------------------

oc create -f ticket-processor-service-secret.yaml

stock-processor-service
------------------------

oc create -f stock-processor-service-secret.yaml

stock-query-service
-------------------

oc create -f stock-query-service-secret.yaml


Maven deployment command
________________________

mvn clean fabric8:deploy -Popenshift

oc scale dc/stock-processor-service --replicas=2


Istio Installation
__________________

Minishift Istio addon: https://github.com/minishift/minishift-addons/tree/master/add-ons/istio

Istio tutorials: https://github.com/redhat-developer-demos/istio-tutorial

https://github.com/istio/istio/releases/tag/0.7.1

minishift env setup

eval $(minishift oc-env)
eval $(minishift docker-env)

oc adm policy add-scc-to-user anyuid -z istio-ingress-service-account -n istio-system

oc adm policy add-scc-to-user anyuid -z default -n istio-system

oc adm policy add-scc-to-user anyuid -z prometheus -n istio-system

oc create -f install/kubernetes/istio.yaml

oc project istio-system

oc apply -f install/kubernetes/addons/prometheus.yaml

oc apply -f install/kubernetes/addons/grafana.yaml

oc apply -f install/kubernetes/addons/servicegraph.yaml

oc process -f  https://raw.githubusercontent.com/jaegertracing/jaeger-openshift/master/all-in-one/jaeger-all-in-one-template.yml | oc create -f -

oc expose svc servicegraph

oc expose svc grafana

oc expose svc prometheus

oc expose svc istio-ingress



Istio 1.1.1
___________

export ISTIO_HOME=/Users/jlbuenosvinos/OneDrive/RedHat/Doc/OpenShift/GIT/ocp-microservices-ddd/doc/istio-1.1.1
export PATH=$ISTIO_HOME/bin:$PATH


oc adm policy add-scc-to-user privileged -z default -n ctti-app-dev

oc adm policy add-scc-to-user privileged -z default -n sales-demo-app-dev

oc adm policy add-scc-to-user privileged -z default -n sales-demo-app-pre

oc adm policy add-scc-to-user privileged -z default -n sales-demo-app-pro

https://github.com/redhat-developer-demos/istio-tutorial/blob/master/documentation/modules/ROOT/pages/1setup.adoc


Ansible Tower installation
__________________________

https://store.ansible.com/redhat/tower_license/

Create a postgresql storage using a 10GB of capacity.

Create the new resource limit base on the automation-tools-custom-resource-limits.yaml

Review the inventory to disable the certificate check

./setup_openshift.sh -e openshift_host=https://master.bcn-ffce.openshiftworkshop.com -e openshift_project=automation-tools -e openshift_user=opentlc-mgr -e openshift_password=r3dh4t1! -e admin_password=admin1 -e secret_key=mysecret -e pg_username=postgresuser -e pg_password=postgrespwd -e rabbitmq_password=rabbitpwd -e rabbitmq_erlang_cookie=rabbiterlangpwd

